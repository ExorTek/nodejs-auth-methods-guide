sequenceDiagram
    autonumber
    participant B as ðŸŒ Browser
    participant S as ðŸ–¥ï¸ Backend
    participant DB as ðŸ—„ï¸ MongoDB

    Note over B,S: OAuth callback sonrasÄ±...
    
    rect rgb(80, 40, 40)
        Note over B,S: âŒ GÃ¼vensiz YÃ¶ntemler
        Note over S: Token URL query'de â†’ browser history, log, Referer
        Note over S: Token fragment (#) â†’ browser history
        Note over S: JSON response â†’ SPA yakalayamaz (tam sayfa redirect)
    end

    rect rgb(40, 80, 40)
        Note over B,DB: âœ… AuthTicket Pattern
        S->>DB: Ticket oluÅŸtur (SHA-256 hash, 30sn TTL)
        S-->>B: 302 â†’ frontend?ticket=opaque_string
        Note over B: URL'den ticket oku
        B->>S: POST /api/auth/exchange {ticket}
        S->>DB: findOneAndUpdate<br/>(ticketHash, isUsed:false â†’ true)
        Note over S,DB: Atomic consume â€” race condition yok
        DB-->>S: ticket.userId
        S-->>B: JWT tokens (Authorization + X-Refresh-Token headers)
    end
