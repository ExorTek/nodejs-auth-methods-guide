sequenceDiagram
    autonumber
    participant U as ğŸ‘¤ KullanÄ±cÄ±
    participant B as ğŸŒ Browser
    participant S as ğŸ–¥ï¸ Uygulama<br/>(Express/Fastify)
    participant G as ğŸ” Google<br/>(Auth Server)
    participant API as ğŸ“¡ Google API<br/>(Resource Server)

    U->>B: "Google ile GiriÅŸ Yap" tÄ±kla
    B->>S: GET /api/auth/google
    Note over S: state Ã¼ret ve sakla<br/>(CSRF korumasÄ±)
    S-->>B: 302 Redirect â†’ accounts.google.com
    B->>G: Authorization URL + state + scope
    G-->>U: Login ekranÄ± + consent screen
    U->>G: Ä°zin ver âœ…
    G-->>B: 302 Redirect â†’ /callback?code=xxx&state=yyy
    B->>S: GET /api/auth/google/callback?code=xxx&state=yyy
    Note over S: state doÄŸrula (CSRF check)
    
    rect rgb(40, 40, 80)
        Note over S,G: Server-to-Server (client_secret gÃ¼vende)
        S->>G: POST /token {code, client_id, client_secret}
        G-->>S: {access_token, id_token}
    end
    
    S->>API: GET /userinfo (Bearer access_token)
    API-->>S: {email, name, picture}
    Note over S: User bul/oluÅŸtur<br/>(Account Linking)
    Note over S: AuthTicket oluÅŸtur<br/>(30sn, tek kullanÄ±m)
    S-->>B: 302 Redirect â†’ frontend?ticket=abc
    B->>S: POST /api/auth/exchange {ticket}
    Note over S: Ticket consume (atomic)
    S-->>B: JWT tokens (headers)
